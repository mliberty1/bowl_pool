{% extends "base.html" %}

{% block title %}My Picks - Bowl Pool{% endblock %}

{% block extra_css %}
<style>
    .status-indicator {
        padding: 15px 20px;
        border-radius: 4px;
        margin-bottom: 20px;
        font-weight: bold;
        font-size: 1.1em;
        text-align: center;
    }

    .status-incomplete {
        background-color: #f8d7da;
        color: #721c24;
        border: 2px solid #f5c6cb;
    }

    .status-complete {
        background-color: #d4edda;
        color: #155724;
        border: 2px solid #c3e6cb;
    }

    .status-locked {
        background-color: #e2e3e5;
        color: #383d41;
        border: 2px solid #d6d8db;
    }

    .pick-row {
        display: grid;
        grid-template-columns: 2fr 1fr 2fr 1fr;
        gap: 10px;
        align-items: center;
        padding: 15px;
        margin-bottom: 10px;
        background: white;
        border-radius: 4px;
        border: 1px solid #ddd;
    }

    .pick-row.locked {
        background-color: #f9f9f9;
    }

    .team-pick {
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
    }

    .team-pick:hover:not(.disabled) {
        border-color: #3498db;
        background-color: #ecf0f1;
    }

    .team-pick.selected {
        border-color: #27ae60;
        background-color: #d4edda;
        font-weight: bold;
    }

    .team-pick.disabled {
        cursor: not-allowed;
        opacity: 0.6;
    }

    .spread {
        text-align: center;
        font-weight: bold;
        color: #666;
    }

    .game-info {
        font-size: 0.9em;
        color: #666;
    }

    .save-status {
        text-align: center;
        padding: 10px;
        font-size: 0.9em;
        color: #666;
        margin-top: 20px;
    }

    .save-status.saving {
        color: #856404;
    }

    .save-status.saved {
        color: #155724;
    }

    .action-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 20px;
    }
</style>
{% endblock %}

{% block content %}
<h1>My Picks - {{ participant.get_display_name() }}</h1>

<div>Select the winning team for each game.</div>

{% if not has_unlocked_games %}
    <div class="status-indicator status-locked">
        NO AVAILABLE GAMES - All games have started. Check the scoreboard to see results.
    </div>
{% elif all_picks_made %}
    <div class="status-indicator status-complete" id="status-indicator">
        COMPLETE - All available picks submitted
    </div>
{% else %}
    <div class="status-indicator status-incomplete" id="status-indicator">
        INCOMPLETE - Not all picks made yet
    </div>
{% endif %}

<div>The point spread is added to the team on the left to compute the final score.
The team with the higher score after the spread is the winner.
If the spread is negative, then the left (first) team is favored.
If the spread is positive, then the right (second) team is favored.</div>

<div id="picks-container">
    {% if has_unlocked_games %}
        {% for bowl in bowls %}
        <div class="pick-row">
            <div>
                <strong>{{ bowl.name }}</strong>
                <div class="game-info">
                    <span class="game-time" data-utc="{{ bowl.datetime_utc.isoformat() }}Z">
                        {{ bowl.datetime_utc.strftime('%b %d, %Y %I:%M %p UTC') }}
                    </span>
                    {% if bowl.round != 'first_round' %}
                        <span style="color: #3498db; font-weight: bold; margin-left: 10px;">
                            {{ bowl.round|replace('_', ' ')|title }}
                        </span>
                    {% endif %}
                </div>
            </div>

            <div class="team-pick clickable {% if current_picks.get(bowl.id) == 'favored' %}selected{% endif %}"
                 data-bowl-id="{{ bowl.id }}"
                 data-team="favored"
                 onclick="selectTeam({{ bowl.id }}, 'favored')">
                {{ bowl.favored_team }}
            </div>

            <div class="spread">
                {{ ('+' if bowl.spread >= 0 else '-') ~ (bowl.spread|abs|int if bowl.spread == (bowl.spread|int) else bowl.spread|abs) }}
            </div>

            <div class="team-pick clickable {% if current_picks.get(bowl.id) == 'opponent' %}selected{% endif %}"
                 data-bowl-id="{{ bowl.id }}"
                 data-team="opponent"
                 onclick="selectTeam({{ bowl.id }}, 'opponent')">
                {{ bowl.opponent }}
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div style="text-align: center; padding: 40px; color: #666;">
            <p style="font-size: 1.2em;">No games available for picking at this time.</p>
            <p>All games have already started. Visit the <a href="{{ url_for('scoreboard') }}">scoreboard</a> to see the results!</p>
        </div>
    {% endif %}
</div>

{% if has_unlocked_games %}
<div class="save-status" id="save-status">
    Ready
</div>

<div class="action-buttons">
    <button type="button" class="btn btn-danger" onclick="clearPicks()">Clear All Picks</button>
    <button type="button" class="btn btn-success" onclick="randomizePicks()">Randomize Remaining</button>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
let isSaving = false;

// Convert UTC times to local timezone
document.addEventListener('DOMContentLoaded', function() {
    const gameTimes = document.querySelectorAll('.game-time');
    gameTimes.forEach(function(timeElement) {
        const utcTime = timeElement.getAttribute('data-utc');
        if (utcTime) {
            const date = new Date(utcTime);
            // Format: "Dec 20, 3:30 PM EST"
            const options = {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                timeZoneName: 'short'
            };
            timeElement.textContent = date.toLocaleString('en-US', options);
        }
    });
});

// Get CSRF token from meta tag
function getCsrfToken() {
    return "{{ csrf_token() }}";
}

function updateStatus(isActive, totalPicks, totalBowls) {
    const statusIndicator = document.getElementById('status-indicator');
    if (totalPicks === totalBowls && isActive) {
        statusIndicator.className = 'status-indicator status-complete';
        statusIndicator.textContent = 'COMPLETE - All picks submitted';
    } else {
        statusIndicator.className = 'status-indicator status-incomplete';
        statusIndicator.textContent = 'INCOMPLETE - Not all picks made yet';
    }
}

function updateSaveStatus(status) {
    const saveStatus = document.getElementById('save-status');
    if (status === 'saving') {
        saveStatus.className = 'save-status saving';
        saveStatus.textContent = 'Saving...';
    } else if (status === 'saved') {
        const now = new Date();
        const timestamp = now.getFullYear() + '-' +
            String(now.getMonth() + 1).padStart(2, '0') + '-' +
            String(now.getDate()).padStart(2, '0') + ' ' +
            String(now.getHours()).padStart(2, '0') + ':' +
            String(now.getMinutes()).padStart(2, '0') + ':' +
            String(now.getSeconds()).padStart(2, '0');
        saveStatus.className = 'save-status saved';
        saveStatus.textContent = 'Saved at ' + timestamp;
    }
}

function selectTeam(bowlId, team) {
    // Update visual selection immediately
    const pickRow = document.querySelector(`.team-pick[data-bowl-id="${bowlId}"][data-team="${team}"]`).closest('.pick-row');
    pickRow.querySelectorAll('.team-pick').forEach(el => el.classList.remove('selected'));
    document.querySelector(`.team-pick[data-bowl-id="${bowlId}"][data-team="${team}"]`).classList.add('selected');

    // Auto-save
    updateSaveStatus('saving');

    fetch('/api/save-pick', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken(),
        },
        body: JSON.stringify({
            bowl_id: bowlId,
            picked_team: team
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateSaveStatus('saved');
            updateStatus(data.is_active, data.total_picks, data.total_bowls);
        } else {
            alert('Error saving pick: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving pick');
    });
}

function clearPicks() {
    if (!confirm('Are you sure you want to clear all picks?')) {
        return;
    }

    updateSaveStatus('saving');

    fetch('/api/clear-picks', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken(),
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove all selections
            document.querySelectorAll('.team-pick.selected').forEach(el => {
                el.classList.remove('selected');
            });
            updateSaveStatus('saved');
            updateStatus(false, 0, {{ bowls|length }});
        } else {
            alert('Error clearing picks: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error clearing picks');
    });
}

function randomizePicks() {
    if (!confirm('Randomize all remaining picks? This will complete your submission.')) {
        return;
    }

    updateSaveStatus('saving');

    fetch('/api/randomize-picks', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken(),
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update UI with randomized picks
            for (const [bowlId, team] of Object.entries(data.picks)) {
                const pickRow = document.querySelector(`.team-pick[data-bowl-id="${bowlId}"]`).closest('.pick-row');
                pickRow.querySelectorAll('.team-pick').forEach(el => el.classList.remove('selected'));
                document.querySelector(`.team-pick[data-bowl-id="${bowlId}"][data-team="${team}"]`).classList.add('selected');
            }
            updateSaveStatus('saved');
            updateStatus(true, {{ bowls|length }}, {{ bowls|length }});
        } else {
            alert('Error randomizing picks: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error randomizing picks');
    });
}
</script>
{% endblock %}
