{% extends "base.html" %}

{% block title %}My Picks - Bowl Pool{% endblock %}

{% block extra_css %}
<style>
    .status-indicator {
        padding: 15px 20px;
        border-radius: 4px;
        margin-bottom: 20px;
        font-weight: bold;
        font-size: 1.1em;
        text-align: center;
    }

    .status-incomplete {
        background-color: #f8d7da;
        color: #721c24;
        border: 2px solid #f5c6cb;
    }

    .status-complete {
        background-color: #d4edda;
        color: #155724;
        border: 2px solid #c3e6cb;
    }

    .status-locked {
        background-color: #e2e3e5;
        color: #383d41;
        border: 2px solid #d6d8db;
    }

    .pick-row {
        display: grid;
        grid-template-columns: 2fr 1fr 2fr 1fr;
        gap: 10px;
        align-items: center;
        padding: 15px;
        margin-bottom: 10px;
        background: white;
        border-radius: 4px;
        border: 1px solid #ddd;
    }

    .pick-row.locked {
        background-color: #f9f9f9;
    }

    .team-pick {
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
    }

    .team-pick:hover:not(.disabled) {
        border-color: #3498db;
        background-color: #ecf0f1;
    }

    .team-pick.selected {
        border-color: #27ae60;
        background-color: #d4edda;
        font-weight: bold;
    }

    .team-pick.disabled {
        cursor: not-allowed;
        opacity: 0.6;
    }

    .spread {
        text-align: center;
        font-weight: bold;
        color: #666;
    }

    .game-info {
        font-size: 0.9em;
        color: #666;
    }

    .save-status {
        text-align: center;
        padding: 10px;
        font-size: 0.9em;
        color: #666;
        margin-top: 20px;
    }

    .save-status.saving {
        color: #856404;
    }

    .save-status.saved {
        color: #155724;
    }

    .action-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 20px;
    }
</style>
{% endblock %}

{% block content %}
<h1>My Picks - {{ participant.get_display_name() }}</h1>

{% if locked %}
    <div class="status-indicator status-locked">
        LOCKED - Picks are finalized
    </div>
{% elif participant.is_active %}
    <div class="status-indicator status-complete" id="status-indicator">
        COMPLETE - All picks submitted
    </div>
{% else %}
    <div class="status-indicator status-incomplete" id="status-indicator">
        INCOMPLETE - Not all picks made yet
    </div>
{% endif %}

<div id="picks-container">
    {% for bowl in bowls %}
    <div class="pick-row {% if locked %}locked{% endif %}">
        <div>
            <strong>{{ bowl.name }}</strong>
            <div class="game-info">{{ bowl.datetime_utc.strftime('%b %d, %Y %I:%M %p UTC') }}</div>
        </div>

        <div class="team-pick {% if not locked %}clickable{% else %}disabled{% endif %} {% if current_picks.get(bowl.id) == 'favored' %}selected{% endif %}"
             data-bowl-id="{{ bowl.id }}"
             data-team="favored"
             onclick="{% if not locked %}selectTeam({{ bowl.id }}, 'favored'){% endif %}">
            {{ bowl.favored_team }}
        </div>

        <div class="spread">
            {{ bowl.spread }}
        </div>

        <div class="team-pick {% if not locked %}clickable{% else %}disabled{% endif %} {% if current_picks.get(bowl.id) == 'opponent' %}selected{% endif %}"
             data-bowl-id="{{ bowl.id }}"
             data-team="opponent"
             onclick="{% if not locked %}selectTeam({{ bowl.id }}, 'opponent'){% endif %}">
            {{ bowl.opponent }}
        </div>
    </div>
    {% endfor %}
</div>

{% if not locked %}
<div class="save-status" id="save-status">
    Ready
</div>

<div class="action-buttons">
    <button type="button" class="btn btn-danger" onclick="clearPicks()">Clear All Picks</button>
    <button type="button" class="btn btn-success" onclick="randomizePicks()">Randomize Remaining</button>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
let isSaving = false;

// Get CSRF token from meta tag
function getCsrfToken() {
    return "{{ csrf_token() }}";
}

function updateStatus(isActive, totalPicks, totalBowls) {
    const statusIndicator = document.getElementById('status-indicator');
    if (totalPicks === totalBowls && isActive) {
        statusIndicator.className = 'status-indicator status-complete';
        statusIndicator.textContent = 'COMPLETE - All picks submitted';
    } else {
        statusIndicator.className = 'status-indicator status-incomplete';
        statusIndicator.textContent = 'INCOMPLETE - Not all picks made yet';
    }
}

function updateSaveStatus(status) {
    const saveStatus = document.getElementById('save-status');
    if (status === 'saving') {
        saveStatus.className = 'save-status saving';
        saveStatus.textContent = 'Saving...';
    } else if (status === 'saved') {
        const now = new Date();
        const timestamp = now.getFullYear() + '-' +
            String(now.getMonth() + 1).padStart(2, '0') + '-' +
            String(now.getDate()).padStart(2, '0') + ' ' +
            String(now.getHours()).padStart(2, '0') + ':' +
            String(now.getMinutes()).padStart(2, '0') + ':' +
            String(now.getSeconds()).padStart(2, '0');
        saveStatus.className = 'save-status saved';
        saveStatus.textContent = 'Saved at ' + timestamp;
    }
}

function selectTeam(bowlId, team) {
    {% if locked %}
    return;
    {% endif %}

    // Update visual selection immediately
    const pickRow = document.querySelector(`.team-pick[data-bowl-id="${bowlId}"][data-team="${team}"]`).closest('.pick-row');
    pickRow.querySelectorAll('.team-pick').forEach(el => el.classList.remove('selected'));
    document.querySelector(`.team-pick[data-bowl-id="${bowlId}"][data-team="${team}"]`).classList.add('selected');

    // Auto-save
    updateSaveStatus('saving');

    fetch('/api/save-pick', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken(),
        },
        body: JSON.stringify({
            bowl_id: bowlId,
            picked_team: team
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateSaveStatus('saved');
            updateStatus(data.is_active, data.total_picks, data.total_bowls);
        } else {
            alert('Error saving pick: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving pick');
    });
}

function clearPicks() {
    if (!confirm('Are you sure you want to clear all picks?')) {
        return;
    }

    updateSaveStatus('saving');

    fetch('/api/clear-picks', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken(),
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove all selections
            document.querySelectorAll('.team-pick.selected').forEach(el => {
                el.classList.remove('selected');
            });
            updateSaveStatus('saved');
            updateStatus(false, 0, {{ bowls|length }});
        } else {
            alert('Error clearing picks: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error clearing picks');
    });
}

function randomizePicks() {
    if (!confirm('Randomize all remaining picks? This will complete your submission.')) {
        return;
    }

    updateSaveStatus('saving');

    fetch('/api/randomize-picks', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken(),
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update UI with randomized picks
            for (const [bowlId, team] of Object.entries(data.picks)) {
                const pickRow = document.querySelector(`.team-pick[data-bowl-id="${bowlId}"]`).closest('.pick-row');
                pickRow.querySelectorAll('.team-pick').forEach(el => el.classList.remove('selected'));
                document.querySelector(`.team-pick[data-bowl-id="${bowlId}"][data-team="${team}"]`).classList.add('selected');
            }
            updateSaveStatus('saved');
            updateStatus(true, {{ bowls|length }}, {{ bowls|length }});
        } else {
            alert('Error randomizing picks: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error randomizing picks');
    });
}
</script>
{% endblock %}
